<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>elasticsearch</title>
    <url>/posts/60537c10/</url>
    <content><![CDATA[<h2 id="一、ES查询"><a href="#一、ES查询" class="headerlink" title="一、ES查询"></a>一、ES查询</h2><hr>
<p> ES查询分为两种，一种是查询（query），另一种是过滤（filter）。</p>
<ul>
<li>query默认会计算返回文档的得分，然后根据得分进行排序</li>
<li>filter只会筛选出符合条件的文档，不会计算得分，查询的结果可以被缓存。<blockquote>
<p>单从性能的角度来看，过滤优于查询。如果只是大范围筛选数据不考虑相关度得分，使用filter，如果对排序结果又要求，需要将匹配的文档排在最前面，使用query</p>
</blockquote>
</li>
</ul>
<h3 id="1、查询（query）的使用"><a href="#1、查询（query）的使用" class="headerlink" title="1、查询（query）的使用"></a>1、查询（query）的使用</h3><p>查询包括 <code>match</code>、<code>match_phrase</code>、<code>match_phrase_prefix</code>、<code>multi_match </code>、<code>range </code>、<code>term </code>、<code>terms </code>、<code>exists</code>、<code>missing</code></p>
<table>
<thead>
<tr>
<th>查询关键字</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>match</td>
<td>会将搜索词（输入条件）做分词，然后与目标字段做匹配，若分词中任意一个词与目标字段匹配上，那么这个文档满足条件</td>
</tr>
<tr>
<td>match_phrase</td>
<td>精确匹配查询的短语，需要全部单词和顺序要完全一样，标点符号除外</td>
</tr>
<tr>
<td>match_phrase_prefix</td>
<td>和 match_phrase 用法是一样的，区别就在于它允许对最后一个词条前缀匹配</td>
</tr>
<tr>
<td>multi_match</td>
<td>可以在多个字段上执行相同的 match 查询</td>
</tr>
<tr>
<td>range</td>
<td>出那些落在指定区间内的数字或者时间</td>
</tr>
<tr>
<td>term</td>
<td>精确值匹配，这些精确值可能是数字、时间、布尔或者 not_analyzed 的字符串</td>
</tr>
<tr>
<td>terms</td>
<td>和 term 查询一样，区别在于可以传入多个值。如果目标字段包含了指定值中的任何一个值，那么这个文档满足条件</td>
</tr>
<tr>
<td>exists</td>
<td>用于查找指定字段中有值的文档</td>
</tr>
<tr>
<td>missing</td>
<td>用于查找指定字段中没有值的文档(ES 5之后版本已经移除)</td>
</tr>
</tbody></table>
<ul>
<li><p><code>match</code>查询使用<br><code>GET test-index/_search</code></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhanghao&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>match_phrase</code> 使用<br><code>GET test-index/_search</code></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_phrase&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhanghao&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>match_phrase_prefix</code>使用</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_phrase_prefix&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhanghao&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>multi_match</code>查询</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;multi_match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhangsan&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;name&quot;</span><span class="punctuation">,</span> <span class="string">&quot;description&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>range</code>查询</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span> <span class="number">20</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>term</code> 查询</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lisi&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>terms</code> 查询</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;zhangsan&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;lisi&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>exists</code> 查询</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;exists&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>missing</code>查询（ES 5之前版本支持）</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;missing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2、过滤（filter）的使用"><a href="#2、过滤（filter）的使用" class="headerlink" title="2、过滤（filter）的使用"></a>2、过滤（filter）的使用</h3><ul>
<li>filter 和 <code>term</code> 使用<br><code>GET test-index/_search</code><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;zhanghao&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li>filter 和 <code>terms</code> 使用<br><code>GET test-index/_search</code><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">GET test-index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="string">&quot;zhanghao&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;lisi&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li>filter和bool使用<br><code>GET test-index/_search</code><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhanghao&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li>多个过滤条件<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;18&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>还有ids、ranage、exists 等过滤器，使用方法基本一致。</p>
</blockquote>
]]></content>
      <tags>
        <tag>Elasticsearch</tag>
        <tag>全文搜索引擎</tag>
      </tags>
  </entry>
  <entry>
    <title>git-multi-account-tutorial</title>
    <url>/posts/3e482544/</url>
    <content><![CDATA[<h4 id="1、如果设置过全局的username-和email，清空全局配置的username和email"><a href="#1、如果设置过全局的username-和email，清空全局配置的username和email" class="headerlink" title="1、如果设置过全局的username 和email，清空全局配置的username和email"></a>1、如果设置过全局的<code>username</code> 和<code>email</code>，清空全局配置的<code>username</code>和<code>email</code></h4><ul>
<li>查看git全局config配置<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git config --list</span><br></pre></td></tr></table></figure></li>
<li>清空默认邮箱和用户名<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git config --global --unset user.name</span><br><span class="line">git config --global --unset user.email</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2、为不同的git账户生成RSA公私钥"><a href="#2、为不同的git账户生成RSA公私钥" class="headerlink" title="2、为不同的git账户生成RSA公私钥"></a>2、为不同的git账户生成RSA公私钥</h4><ul>
<li><p>生成密钥</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh-keygent -t rsa -C &quot;[email-address]&quot;</span><br></pre></td></tr></table></figure>
<p>eg:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;huan.wenlong@gmail.com&quot;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/c/Users/huan.wenlong/.ssh/id_rsa):</span><br></pre></td></tr></table></figure></li>
<li><p>输入密钥名称<br><strong>此时输入文件名称，多个账户时名称不能重复</strong></p>
</li>
<li><p>接下来配置密码，如果需要设置可以输入密码，如果不需要一路回车即可</p>
</li>
</ul>
<hr>
<p>以下以配置<code>GitHub</code>和<code>gitee</code>为例</p>
<ul>
<li><p>GitHub</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;huan.wenlong.529@gmail.com&quot;</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/c/Users/huan.wenlong/.ssh/id_rsa): github</span><br><span class="line">Enter passphrase (empty for no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved in github</span><br><span class="line">Your public key has been saved in github.pub</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:zlgu9ku5ptduRu3gf/ZJDKCf7E3XiVkBZwLiSR2WaV8 huan.wenlong.529@gmail.com</span><br><span class="line">The key&#x27;s randomart image is:</span><br><span class="line">+---[RSA 3072]----+</span><br><span class="line">|         o.+=o o |</span><br><span class="line">|        o +=  =E |</span><br><span class="line">|         o... .. |</span><br><span class="line">|          . ..  .|</span><br><span class="line">|        S. . . . |</span><br><span class="line">|       * .= o * o|</span><br><span class="line">|      + *+ * + =.|</span><br><span class="line">|     . +o.* + = .|</span><br><span class="line">|      .++=.o.+ o.|</span><br><span class="line">+----[SHA256]-----+</span><br></pre></td></tr></table></figure>
</li>
<li><p>gitee</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ssh-keygen -t rsa -C <span class="string">&quot;381897190@qq.com&quot;</span></span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/c/Users/huan.wenlong/.ssh/id_rsa): gitee</span><br><span class="line">Enter passphrase (empty for no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved in gitee</span><br><span class="line">Your public key has been saved in gitee.pub</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:sCDg0WghkvmprbjmzFm0PkzseLss+O8z2PtQgAtoqjw 381897190@qq.com</span><br><span class="line">The key&#x27;s randomart image is:</span><br><span class="line">+---[RSA 3072]----+</span><br><span class="line">|+=+              |</span><br><span class="line">|B+.o             |</span><br><span class="line">|++o.o .          |</span><br><span class="line">|o.oo o o         |</span><br><span class="line">|.oo.  o S        |</span><br><span class="line">|+ oo..           |</span><br><span class="line">|+E==.            |</span><br><span class="line">|*+B=+.           |</span><br><span class="line">|+B+BB=.          |</span><br><span class="line">+----[SHA256]-----+</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="3、配置GitHub或Gitee公钥"><a href="#3、配置GitHub或Gitee公钥" class="headerlink" title="3、配置GitHub或Gitee公钥"></a>3、配置<code>GitHub</code>或<code>Gitee</code>公钥</h4><p><img src="/resources/assets/3e482544/20230423152155.png" alt="github"><br><img src="/resources/assets/3e482544/20230423152343.png" alt="gitee"></p>
<p>将刚才生成的密钥以文本方式打开复制到<code>github</code>或<code>gitee</code>中添加密钥即可。</p>
<h4 id="4、配置git-config"><a href="#4、配置git-config" class="headerlink" title="4、配置git config"></a>4、配置git config</h4><ul>
<li>打开<code>~/.ssh</code>目录</li>
<li>查看是否由<code>config</code>文件，有则修改，没有则添加<br>以下为示例，具体可参考 <a href="https://man7.org/linux/man-pages/man5/ssh_config.5.html?spm=a2c4g.322237.0.0.6760114agqwpwm">sshconfig</a><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">Host 别名</span><br><span class="line">HostName 域名</span><br><span class="line">User 用户</span><br><span class="line">IdentityFile 密钥路径</span><br><span class="line">PreferredAuthentications 认证首选</span><br></pre></td></tr></table></figure>
以下为添加<code>GitHub</code>和<code>gitee</code>的示例<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">Host github</span><br><span class="line">HostName github.com</span><br><span class="line">User git</span><br><span class="line">IdentityFile ~/.ssh/github</span><br><span class="line">PreferredAuthentications publickey</span><br><span class="line"></span><br><span class="line">Host gitee</span><br><span class="line">HostName gitee.com</span><br><span class="line">User git</span><br><span class="line">IdentityFile ~/.ssh/gitee</span><br><span class="line">PreferredAuthentications publickey</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="5、添加RSA公钥到信任列表"><a href="#5、添加RSA公钥到信任列表" class="headerlink" title="5、添加RSA公钥到信任列表"></a>5、添加RSA公钥到信任列表</h4><ul>
<li><p>确保<code>ssh-agent</code>处于运行中，如果未运行需要运行<code>ssh-agent</code><br>Windows下运行<code>ssh-agent</code>如下<br>打开服务，找到<code>OpenSSH Authentication Agent</code>设置为自动运行<br><img src="/resources/assets/3e482544/20230423154352.png" alt="ssh-agent"></p>
</li>
<li><p>添加RSA到SSH agent</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh-add ~/.ssh/[name]</span><br></pre></td></tr></table></figure>
<p>其中<code>name</code>为刚才生成的文件名称<br>此处以添加<code>GitHub</code>和<code>gitee</code>为例</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh-add ~/.ssh/github</span><br><span class="line">ssh-add ~/.ssh/gitee</span><br></pre></td></tr></table></figure>

<h4 id="6、测试连接"><a href="#6、测试连接" class="headerlink" title="6、测试连接"></a>6、测试连接</h4><ul>
<li><p>单账号</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh -T git@gitee.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>多账号</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh -T git@[config 中的user]@[config 中的host]</span><br></pre></td></tr></table></figure></li>
</ul>
<p>eg：gitee</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh -T git@git@gitee</span><br></pre></td></tr></table></figure>
<p>第一次会出现不能建立连接，询问是否继续，输入<code>yes</code>回车即可</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">The authenticity of host &#x27;gitee.com (212.64.63.190)&#x27; can&#x27;t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:FQGC9Kn/eye1W8icdBgrQp+KkGYoFgbVr17bmjey0Wc.</span><br><span class="line">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span><br><span class="line">Warning: Permanently added &#x27;gitee.com,212.64.63.190&#x27; (ECDSA) to the list of known hosts.</span><br></pre></td></tr></table></figure>

<p>看到如下信息就说明成功了</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Hi Monster! You&#x27;ve successfully authenticated, but GITEE.COM does not provide shell access.</span><br></pre></td></tr></table></figure>

<hr>
<p>不知道github为啥不能带用户，后面有时间再研究下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ssh -T git@git@github</span></span><br><span class="line">git@git@github.com: Permission denied (publickey).</span><br></pre></td></tr></table></figure>
<p>去掉用户名验证成功</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ssh -T git@github</span></span><br><span class="line">Hi wen-loong! You&#x27;ve successfully authenticated, but GitHub does not provide shell access.</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-local-cluster-install</title>
    <url>/posts/d6ebbcb/</url>
    <content><![CDATA[<h2 id="一、multipass简介及安装"><a href="#一、multipass简介及安装" class="headerlink" title="一、multipass简介及安装"></a>一、multipass简介及安装</h2><p>以下来源于multipass 官网</p>
<blockquote>
<p>Multipass is a lightweight VM manager for Linux, Windows and macOS. It’s designed for developers who want a fresh Ubuntu environment with a single command. It uses KVM on Linux, Hyper-V on Windows and QEMU on macOS to run the VM with minimal overhead. It can also use VirtualBox on Windows and macOS. Multipass will fetch images for you and keep them up to date.</p>
</blockquote>
<p>它是一个是一个轻量级的VM管理器，适用于希望使用单个命令获得全新 Ubuntu 环境的开发人员。</p>
<p>安装和配置详见<a href="https://multipass.run/">官网</a>和<a href="https://github.com/canonical/multipass">GitHub</a>，此处不做过多赘述。</p>
<h4 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a>创建虚拟机</h4><p>本次共创建三台虚拟机，一台master节点，两台worker节点</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">multipass launch --name master --cpus 2 --memory 8192M --disk 30G</span><br><span class="line">multipass launch --name node1 --cpus 1 --memory 4096M --disk 30G</span><br><span class="line">multipass launch --name node2 --cpus 1 --memory 4096M --disk 30G</span><br></pre></td></tr></table></figure>
<p>进入虚拟机使用如下命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">multipass shell [VM-name]</span><br></pre></td></tr></table></figure>
<p>由于重启之后虚拟机的IP会变化，此处使用静态IP进行处理，可以使用<code>--network </code>参数指定，但是依旧没有固定IP，所以启动之后进入VM手动添加<code>eth0</code>网卡设置固定IP</p>
<p>添加网络启动参数示例</p>
<blockquote>
<p>multipass launch –name master –cpus 2 –memory 4096M –disk 30G –network name&#x3D;ext-Switch,mode&#x3D;manual</p>
</blockquote>
<p><strong>以下是为VM设置固定IP的步骤(Windows + hyper-v)</strong></p>
<ul>
<li>打开<code>hyper-v manager</code>—&gt; <code>virtual-switch-manager</code>–&gt; <code>new virtual netw switch </code>，如下图所示<br><img src="/resources/assets/d6ebbcb/20230707151910.png" alt="hyper-v-switch"></li>
<li>netplan 是 ubuntu 维护网卡信息的地方，配置文件地址在 <code>/etc/netplan/</code>目录下<br>该目录下只有一个文件，<code>50-cloud-init.yaml</code>，修改将该文件备份，然后加入固定IP（IP基于默认的虚拟网卡自行设置）<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo vi /etc/netplan/50-cloud-init.yaml</span><br></pre></td></tr></table></figure></li>
<li>修改文件内容<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">network:</span></span><br><span class="line">    <span class="attr">ethernets:</span></span><br><span class="line">        <span class="attr">eth0:</span></span><br><span class="line">            <span class="attr">dhcp4:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">match:</span></span><br><span class="line">                <span class="attr">macaddress:</span> <span class="number">52</span><span class="string">:54:00:5d:df:a6</span></span><br><span class="line">            <span class="attr">set-name:</span> <span class="string">eth0</span></span><br><span class="line">        <span class="attr">eth1:</span></span><br><span class="line">            <span class="attr">addresses:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="number">172.28</span><span class="number">.128</span><span class="number">.3</span><span class="string">/17</span></span><br><span class="line">            <span class="attr">nameservers:</span></span><br><span class="line">                <span class="attr">addresses:</span> [<span class="number">172.28</span><span class="number">.128</span><span class="number">.1</span>]</span><br><span class="line">            <span class="attr">routes:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">default</span></span><br><span class="line">                  <span class="attr">via:</span> <span class="number">172.28</span><span class="number">.128</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure></li>
<li>应用修改<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo netplan --debug apply</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="kubernetes本地集群搭建"><a href="#kubernetes本地集群搭建" class="headerlink" title="kubernetes本地集群搭建"></a>kubernetes本地集群搭建</h2><p>此处使用<code>kubeadm</code>和<code>docker</code>搭建</p>
<h5 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁用交换分区(在旧版的 k8s 中 kubelet 都要求关闭 swapoff ，但最新版的 kubelet 其实已经支持 swap ，因此这一步其实可以不做。)</span></span><br><span class="line">swapoff -a</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">永久禁用，打开/etc/fstab注释掉swap那一行。</span>  </span><br><span class="line">sudo vim /etc/fstab</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改内核参数(首先确认你的系统已经加载了 br_netfilter 模块，默认是没有该模块的，需要你先安装 bridge-utils)</span></span><br><span class="line">apt-get install -y bridge-utils</span><br><span class="line">modprobe br_netfilter</span><br><span class="line">lsmod | grep br_netfilter</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果报错找不到包，需要先更新 apt-get update -y</span></span><br><span class="line">swapoff -a</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="docker安装及启动"><a href="#docker安装及启动" class="headerlink" title="docker安装及启动"></a><code>docker</code>安装及启动</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install docker.io -y</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置开机启动并启动docker</span>  </span><br><span class="line">sudo systemctl start docker</span><br><span class="line">sudo systemctl enable docker</span><br></pre></td></tr></table></figure>

<h5 id="kubelet-kubeadm-kubectl的安装"><a href="#kubelet-kubeadm-kubectl的安装" class="headerlink" title="kubelet kubeadm``kubectl的安装"></a><code>kubelet</code> <code>kubeadm``kubectl</code>的安装</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装基础环境</span></span><br><span class="line">apt-get install -y ca-certificates curl software-properties-common apt-transport-https curl</span><br><span class="line">curl -s https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行配置k8s阿里云源</span>  </span><br><span class="line">vim /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">加入以下内容</span></span><br><span class="line">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行更新</span></span><br><span class="line">apt-get update -y</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装kubeadm、kubectl、kubelet</span>  </span><br><span class="line">apt-get install -y kubelet=1.23.1-00 kubeadm=1.23.1-00 kubectl=1.23.1-00</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">阻止自动更新(apt upgrade时忽略)。所以更新的时候先unhold，更新完再hold。</span></span><br><span class="line">apt-mark hold kubelet kubeadm kubectl</span><br></pre></td></tr></table></figure>

<h5 id="初始化master节点"><a href="#初始化master节点" class="headerlink" title="初始化master节点"></a>初始化<code>master</code>节点</h5><p>由于网络问题无法访问k8s的repository此处使用aliyun的，可以使用<code>kubeadm config images pull</code> 来测试与 <code>gcr.io</code> 的连接</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubeadm init --pod-network-cidr=10.244.0.0/16 --image-repository registry.aliyuncs.com/google_containers</span><br></pre></td></tr></table></figure>
<p>也可以将<code>image</code>直接导入或者使用aliyun下载镜像之后重新打<code>tag</code><br>使用<code>kubeadm config images list</code>查依赖的images有哪些：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">root@master:~# kubeadm config images list</span><br><span class="line">I0706 15:09:33.039269    4295 version.go:255] remote version is much newer: v1.27.3; falling back to: stable-1.23</span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.23.17</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.23.17</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.23.17</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.23.17</span><br><span class="line">k8s.gcr.io/pause:3.6</span><br><span class="line">k8s.gcr.io/etcd:3.5.1-0</span><br><span class="line">k8s.gcr.io/coredns/coredns:v1.8.6</span><br></pre></td></tr></table></figure>
<p>将原来的<code>k8s.gcr.io</code>替换为<code>registry.cn-hangzhou.aliyuncs.com/google_containers/</code> 手动拉取下来再重新打tag为<code>k8s.gcr.io</code>即可<br>初始化成功之后会有如下提示</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, if you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  export KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 172.28.129.245:6443 --token aenz2j.dthwj7q39fz5pgv0 \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:60f0c3f424c389a6615aac0186ce9f387053e715142fd9a0f9cd3848c47ef17e</span><br></pre></td></tr></table></figure>
<p>可以使用最后的 <code>kubeadm join</code>命令将其他worker节点加入进来。</p>
<p>使用 <code>kubectl get node</code>检查节点状态</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ubuntu@master:~$ kubectl get nodes</span><br><span class="line">NAME     STATUS     ROLES                  AGE   VERSION</span><br><span class="line">master   NotReady   control-plane,master   16m   v1.23.1</span><br><span class="line">node1    NotReady   &lt;none&gt;                 77s   v1.23.1</span><br><span class="line">node2    NotReady   &lt;none&gt;                 51s   v1.23.1</span><br></pre></td></tr></table></figure>
<p>这里显示节点<code>NotReady</code>的状态，使用<code>kubectl get pod -n kube-system</code> 查看pod是否启动成功</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ubuntu@master:~$ kubectl get pod -n kube-system</span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-6d8c4cb4d-rtcft          0/1     Pending   0          16m</span><br><span class="line">coredns-6d8c4cb4d-vmlfc          0/1     Pending   0          16m</span><br><span class="line">etcd-master                      1/1     Running   0          17m</span><br><span class="line">kube-apiserver-master            1/1     Running   0          17m</span><br><span class="line">kube-controller-manager-master   1/1     Running   0          17m</span><br><span class="line">kube-proxy-cx7x2                 1/1     Running   0          2m45s</span><br><span class="line">kube-proxy-m5xb9                 1/1     Running   0          16m</span><br><span class="line">kube-proxy-nk4ct                 1/1     Running   0          2m19s</span><br><span class="line">kube-scheduler-master            1/1     Running   0          17m</span><br></pre></td></tr></table></figure>
<p><strong>查看日志</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ubuntu@master:~$ sudo journalctl -f -u kubelet</span><br><span class="line">Jul 06 15:45:06 master kubelet[10429]: E0706 15:45:06.095625   10429 kubelet.go:2347] &quot;Container runtime network not ready&quot; networkReady=&quot;NetworkReady=false reason:NetworkPluginNotReady message:docker: network plugin is not ready: cni config uninitialized&quot;</span><br><span class="line">Jul 06 15:45:09 master kubelet[10429]: I0706 15:45:09.454481   10429 cni.go:240] &quot;Unable to update cni config&quot; err=&quot;no networks found in /etc/cni/net.d&quot;</span><br><span class="line">Jul 06 15:45:11 master kubelet[10429]: E0706 15:45:11.102104   10429 kubelet.go:2347] &quot;Container runtime network not ready&quot; networkReady=&quot;NetworkReady=false reason:NetworkPluginNotReady message:docker: network plugin is not ready: cni config uninitialized&quot;</span><br><span class="line">Jul 06 15:45:14 master kubelet[10429]: I0706 15:45:14.455219   10429 cni.go:240] &quot;Unable to update cni config&quot; err=&quot;no networks found in /etc/cni/net.d&quot;</span><br><span class="line">Jul 06 15:45:16 master kubelet[10429]: E0706 15:45:16.110079   10429 kubelet.go:2347] &quot;Container runtime network not ready&quot; networkReady=&quot;NetworkReady=false reason:NetworkPluginNotReady message:docker: network plugin is not ready: cni config uninitialized&quot;</span><br></pre></td></tr></table></figure>
<p>原因是没有安装CNI插件<br>此处解决办法是手动部署一下CNI<a href="https://github.com/flannel-io/flannel">参考地址</a><br>执行<code>kubectl apply -f kube-flannel.yml</code> 部署一下flannel，然后使用命令<code>sudo systemctl restart kubelet</code> 重启kubelet，重启好之后再查看节点就是<code>Ready</code>状态。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ubuntu@master:~$ kubectl get nodes</span><br><span class="line">NAME     STATUS   ROLES                  AGE   VERSION</span><br><span class="line">master   Ready    control-plane,master   30m   v1.23.1</span><br><span class="line">node1    Ready    &lt;none&gt;                 15m   v1.23.1</span><br><span class="line">node2    Ready    &lt;none&gt;                 15m   v1.23.1</span><br></pre></td></tr></table></figure>

<p>以下是<code>kube-flannel.yml</code>配置文件</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">flannel</span></span><br><span class="line">    <span class="attr">pod-security.kubernetes.io/enforce:</span> <span class="string">privileged</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networking.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">clustercidrs</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-flannel</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-flannel</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-flannel</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">flannel</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">cni-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;name&quot;: &quot;cbr0&quot;,</span></span><br><span class="line"><span class="string">      &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span></span><br><span class="line"><span class="string">      &quot;plugins&quot;: [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;flannel&quot;,</span></span><br><span class="line"><span class="string">          &quot;delegate&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;hairpinMode&quot;: true,</span></span><br><span class="line"><span class="string">            &quot;isDefaultGateway&quot;: true</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;portmap&quot;,</span></span><br><span class="line"><span class="string">          &quot;capabilities&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;portMappings&quot;: true</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">net-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span></span><br><span class="line"><span class="string">      &quot;Backend&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;Type&quot;: &quot;vxlan&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-ds</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-flannel</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">flannel</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">flannel</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/os</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">system-node-critical</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">flannel</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install-cni-plugin</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/flannel/flannel-cni-plugin:v1.1.2</span></span><br><span class="line">       <span class="comment">#image: docker.io/rancher/mirrored-flannelcni-flannel-cni-plugin:v1.1.2</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cp</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-f</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/flannel</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/opt/cni/bin/flannel</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni-plugin</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/opt/cni/bin</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install-cni</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/flannel/flannel:v0.22.0</span></span><br><span class="line">       <span class="comment">#image: docker.io/rancher/mirrored-flannelcni-flannel:v0.22.0</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cp</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-f</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/kube-flannel/cni-conf.json</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/cni/net.d/10-flannel.conflist</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-flannel</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/flannel/flannel:v0.22.0</span></span><br><span class="line">       <span class="comment">#image: docker.io/rancher/mirrored-flannelcni-flannel:v0.22.0</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/opt/bin/flanneld</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--ip-masq</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kube-subnet-mgr</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;50Mi&quot;</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">add:</span> [<span class="string">&quot;NET_ADMIN&quot;</span>, <span class="string">&quot;NET_RAW&quot;</span>]</span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">EVENT_QUEUE_DEPTH</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;5000&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/run/flannel</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/kube-flannel/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">xtables-lock</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/run/xtables.lock</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/run/flannel</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni-plugin</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/opt/cni/bin</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cni</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/cni/net.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flannel-cfg</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">xtables-lock</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/run/xtables.lock</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">FileOrCreate</span></span><br></pre></td></tr></table></figure>
<p>接下来部署一个<code>Nginx</code>测试下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ubuntu@master:~$ kubectl create deployment nginx --image=nginx</span><br><span class="line">deployment.apps/nginx created</span><br></pre></td></tr></table></figure>
<p>查看<code>Pod</code>是否已经启动成功</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ubuntu@master:~$ kubectl get pods</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-85b98978db-9495s   1/1     Running   0          109s</span><br></pre></td></tr></table></figure>
<p>使用<code>NodePort</code>方式将<code>Nginx</code> <code>80</code>端口暴露出去</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ubuntu@master:~$ kubectl expose deployment nginx --port=80 --type=NodePort</span><br><span class="line">service/nginx exposed</span><br></pre></td></tr></table></figure>
<p>查看暴露端口</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ubuntu@master:~$ kubectl get pod,svc</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nginx-85b98978db-9495s   1/1     Running   0          2m16s</span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">service/kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP        31m</span><br><span class="line">service/nginx        NodePort    10.104.99.42   &lt;none&gt;        80:31608/TCP   7s</span><br></pre></td></tr></table></figure>
<p>使用VM的IP加上端口号就能访问Nginx服务了<br>获取VM的IP</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">PS C:\Users\38189&gt; multipass list</span><br><span class="line">Name                    State             IPv4             Image</span><br><span class="line">master                  Running           172.28.129.245   Ubuntu 22.04 LTS</span><br><span class="line">                                          172.17.0.1</span><br><span class="line">                                          10.244.0.0</span><br><span class="line">                                          10.244.0.1</span><br><span class="line">node1                   Running           172.28.129.127   Ubuntu 22.04 LTS</span><br><span class="line">                                          172.17.0.1</span><br><span class="line">                                          10.244.1.0</span><br><span class="line">                                          10.244.1.1</span><br><span class="line">node2                   Running           172.28.137.244   Ubuntu 22.04 LTS</span><br><span class="line">                                          172.17.0.1</span><br><span class="line">                                          10.244.2.0</span><br><span class="line">                                          10.244.2.1</span><br></pre></td></tr></table></figure>
<p><strong>开启开机自启</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl enable kubelet</span><br><span class="line">systemctl enable  kubelet.service</span><br></pre></td></tr></table></figure>
<p>至此，kubernetes 本地集群搭建完毕</p>
]]></content>
      <tags>
        <tag>kubernetes</tag>
        <tag>k8s</tag>
        <tag>multipass</tag>
        <tag>cloud native</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes-pv-pvc-usage</title>
    <url>/posts/483d5240/</url>
    <content><![CDATA[<h2 id="一、基本概念"><a href="#一、基本概念" class="headerlink" title="一、基本概念"></a>一、基本概念</h2><h3 id="1、PV"><a href="#1、PV" class="headerlink" title="1、PV"></a>1、PV</h3><p>PV(PersistentVolumn)是集群中的一块存储，可以由管理员事先制备， 或者使用存储类（Storage Class）来动态制备。 持久卷是集群资源，就像节点也是集群资源一样。<a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">详情</a></p>
<h3 id="2、PVC"><a href="#2、PVC" class="headerlink" title="2、PVC"></a>2、PVC</h3><p>PVC(PersistentVolumeClaim)表达的是用户对存储的请求。概念上与 Pod 类似。 Pod 会耗用节点资源，而 PVC 申领会耗用 PV 资源。</p>
<h3 id="SC"><a href="#SC" class="headerlink" title="SC"></a>SC</h3><p>SC(StorageClass) 为管理员提供了描述存储”类”的方法。 不同的类型可能会映射到不同的服务质量等级或备份策略，或是由集群管理员制定的任意策略。 Kubernetes 本身并不清楚各种类代表的什么。这个类的概念在其他存储系统中有时被称为”配置文件”。<br>每个 StorageClass 都包含 provisioner、parameters 和 reclaimPolicy 字段， 这些字段会在 StorageClass 需要动态制备 PersistentVolume 时会使用到。</p>
<p>StorageClass 对象的命名很重要，用户使用这个命名来请求生成一个特定的类。 当创建 StorageClass 对象时，管理员设置 StorageClass 对象的命名和其他参数， 一旦创建了对象就不能再对其更新。<a href="https://kubernetes.io/docs/concepts/storage/storage-classes/">详情</a></p>
<h3 id="Provisioner"><a href="#Provisioner" class="headerlink" title="Provisioner"></a>Provisioner</h3><p>每个 StorageClass 都有一个制备器（Provisioner），用来决定使用哪个卷插件制备 PV。 该字段必须指定。<a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#provisioner">详情</a></p>
<h2 id="二、环境准备"><a href="#二、环境准备" class="headerlink" title="二、环境准备"></a>二、环境准备</h2><h3 id="1、NFS-Server安装"><a href="#1、NFS-Server安装" class="headerlink" title="1、NFS Server安装"></a>1、NFS Server安装</h3><ul>
<li>安装NFS server<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt install nfs-kernel-server -y</span><br></pre></td></tr></table></figure></li>
<li>关闭防火墙<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo ufw disable</span><br></pre></td></tr></table></figure></li>
<li>建立NFS文件夹，并将其配置为共享文件夹<ul>
<li>建立文件夹并授权<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir -p /data/k8s/</span><br><span class="line">sudo chown nobody:nogroup /data/k8s/</span><br><span class="line">sudo chmod 777 /data/k8s/</span><br></pre></td></tr></table></figure></li>
<li>修改<code>/etc/exports</code>，添加 <code>/data/k8s *(insecure,rw,sync,no_root_squash)</code></li>
<li>刷新并重启<code>NFS</code>服务<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo exportfs -ra</span><br><span class="line">systemctl restart rpcbind</span><br><span class="line">sudo systemctl restart rpcbind</span><br><span class="line">sudo systemctl restart nfs</span><br><span class="line">sudo systemctl restart nfs-kernel-server</span><br></pre></td></tr></table></figure>
<blockquote>
<p>nfs允许挂载的目录及权限，在文件&#x2F;etc&#x2F;exports中进行定义，各字段含义如下：<br>&#x2F;home&#x2F;nfs&#x2F;：与nfs服务客户端共享的目录，这个路径必须和你前面设置的文件的路径一致！<br>*：允许所有的网段访问，也可以使用具体的IP<br>rw：挂接此目录的客户端对该共享目录具有读写权限<br>async：资料同步写入内存和硬盘<br>no_root_squash：root用户具有对根目录的完全管理访问权限。<br>no_subtree_check：不检查父目录的权限。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="2、安装NFS-客户端并挂载"><a href="#2、安装NFS-客户端并挂载" class="headerlink" title="2、安装NFS 客户端并挂载"></a>2、安装NFS 客户端并挂载</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-get install nfs-common</span><br><span class="line">sudo mkdir /data/k8s/</span><br><span class="line">sudo mkdir /data/k8s</span><br><span class="line">sudo mkdir -p /data/k8s</span><br><span class="line">sudo mount -t nfs -o nolock -o tcp 192.168.123.5:/data/k8s/ /data/k8s/</span><br></pre></td></tr></table></figure>

<h2 id="三、部署相关K8S资源"><a href="#三、部署相关K8S资源" class="headerlink" title="三、部署相关K8S资源"></a>三、部署相关K8S资源</h2><h3 id="1、-SA-ServiceAccount"><a href="#1、-SA-ServiceAccount" class="headerlink" title="1、 SA(ServiceAccount)"></a>1、 SA(ServiceAccount)</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;patch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<h3 id="2、Deploy-Provisioner"><a href="#2、Deploy-Provisioner" class="headerlink" title="2、Deploy Provisioner"></a>2、Deploy Provisioner</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/external_storage/nfs-client-provisioner:latest</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">fuseim.pri/ifs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">192.168</span><span class="number">.123</span><span class="number">.5</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/data/k8s/</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.123</span><span class="number">.5</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/data/k8s/</span></span><br></pre></td></tr></table></figure>

<h3 id="3、SC-StorageClass"><a href="#3、SC-StorageClass" class="headerlink" title="3、SC(StorageClass)"></a>3、SC(StorageClass)</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">course-nfs-storage</span></span><br><span class="line">  <span class="attr">annotations:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">storageclass.kubernetes.io/is-default-class:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">fuseim.pri/ifs</span></span><br></pre></td></tr></table></figure>

<h2 id="四、PV、PVC使用"><a href="#四、PV、PVC使用" class="headerlink" title="四、PV、PVC使用"></a>四、PV、PVC使用</h2><p>此处以部署<code>MySQL</code>举例</p>
<h3 id="1、PV-PersistentVolume-声明"><a href="#1、PV-PersistentVolume-声明" class="headerlink" title="1、PV(PersistentVolume)声明"></a>1、PV(PersistentVolume)声明</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">500Mi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">course-nfs-storage</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/k8s/</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.123</span><span class="number">.5</span></span><br></pre></td></tr></table></figure>

<h3 id="2、PVC声明"><a href="#2、PVC声明" class="headerlink" title="2、PVC声明"></a>2、PVC声明</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-pvc</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">course-nfs-storage</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">500Mi</span></span><br></pre></td></tr></table></figure>

<h3 id="3、Deployment声明"><a href="#3、Deployment声明" class="headerlink" title="3、Deployment声明"></a>3、Deployment声明</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">progressDeadlineSeconds:</span> <span class="number">300</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">mysql</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_IP</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span> </span><br><span class="line">                <span class="attr">name:</span> <span class="string">mysql-pass</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-config</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">/etc/mysql/my.cnf</span></span><br><span class="line">            <span class="attr">subPath:</span> <span class="string">my.cnf</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-data</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-config</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mysql-config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-data</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">mysql-pvc</span></span><br></pre></td></tr></table></figure>

<h3 id="4、ConfigMap"><a href="#4、ConfigMap" class="headerlink" title="4、ConfigMap"></a>4、ConfigMap</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">my.cnf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    [mysqld]</span></span><br><span class="line"><span class="string">    pid-file        = /var/run/mysqld/mysqld.pid</span></span><br><span class="line"><span class="string">    socket          = /var/run/mysqld/mysqld.sock</span></span><br><span class="line"><span class="string">    datadir         = /var/lib/mysql</span></span><br><span class="line"><span class="string">    lower_case_table_names = 1</span></span><br><span class="line"><span class="string">    secure-file-priv= NULL</span></span><br><span class="line"><span class="string"></span>    </span><br><span class="line">    <span class="comment"># Custom config should go here</span></span><br><span class="line">    <span class="type">!includedir</span> <span class="string">/etc/mysql/conf.d/</span></span><br></pre></td></tr></table></figure>

<h3 id="5、Secrete"><a href="#5、Secrete" class="headerlink" title="5、Secrete"></a>5、Secrete</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-pass</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">MTIzNDU2</span></span><br></pre></td></tr></table></figure>

<h3 id="6、Service"><a href="#6、Service" class="headerlink" title="6、Service"></a>6、Service</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql-service</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">ports:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">3306</span></span><br></pre></td></tr></table></figure>
<h3 id="7、验证"><a href="#7、验证" class="headerlink" title="7、验证"></a>7、验证</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl get pv,pvc -o wide</span><br></pre></td></tr></table></figure>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM               STORAGECLASS         REASON   AGE   VOLUMEMODE</span><br><span class="line">persistentvolume/pvc-7e1f449e-92d2-4d91-b6c6-74fb9e9838d0   500Mi      RWO            Delete           Bound    dev/mysql-pvc       course-nfs-storage            35d   Filesystem</span><br><span class="line">persistentvolume/pvc-d2af51c8-771f-42c7-9672-34887048737a   500Mi      RWO            Delete           Bound    default/mysql-pvc   course-nfs-storage            35d   Filesystem</span><br><span class="line"></span><br><span class="line">NAME                              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS         AGE   VOLUMEMODE</span><br><span class="line">persistentvolumeclaim/mysql-pvc   Bound    pvc-d2af51c8-771f-42c7-9672-34887048737a   500Mi      RWO            course-nfs-storage   35d   Filesystem</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以看到PVC 的状态为<code>Bound</code>说明已经成功</p>
</blockquote>
<p>再到nfs server查看文件是否落盘</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ubuntu@nfs:~$ tree /data/k8s/</span><br><span class="line">/data/k8s/</span><br><span class="line">├── archived-default-mysql-pvc-pvc-c432d8e3-a5e3-40d9-845e-ade26f9ceb23</span><br><span class="line">├── default-mysql-pvc-pvc-d2af51c8-771f-42c7-9672-34887048737a</span><br><span class="line">└── dev-mysql-pvc-pvc-7e1f449e-92d2-4d91-b6c6-74fb9e9838d0</span><br><span class="line">    ├── #ib_16384_0.dblwr</span><br><span class="line">    ├── #ib_16384_1.dblwr</span><br><span class="line">    ├── #innodb_redo  [error opening dir]</span><br><span class="line">    ├── #innodb_temp  [error opening dir]</span><br><span class="line">    ├── auto.cnf</span><br><span class="line">    ├── binlog.000004</span><br><span class="line">    ├── binlog.000005</span><br><span class="line">    ├── binlog.index</span><br><span class="line">    ├── ca-key.pem</span><br><span class="line">    ├── ca.pem</span><br><span class="line">    ├── client-cert.pem</span><br><span class="line">    ├── client-key.pem</span><br><span class="line">    ├── ib_buffer_pool</span><br><span class="line">    ├── ibdata1</span><br><span class="line">    ├── ibtmp1</span><br><span class="line">    ├── mysql  [error opening dir]</span><br><span class="line">    ├── mysql.ibd</span><br><span class="line">    ├── mysql.sock -&gt; /var/run/mysqld/mysqld.sock</span><br><span class="line">    ├── mysql_upgrade_info</span><br><span class="line">    ├── nacos  [error opening dir]</span><br><span class="line">    ├── performance_schema  [error opening dir]</span><br><span class="line">    ├── private_key.pem</span><br><span class="line">    ├── public_key.pem</span><br><span class="line">    ├── server-cert.pem</span><br><span class="line">    ├── server-key.pem</span><br><span class="line">    ├── sys  [error opening dir]</span><br><span class="line">    ├── undo_001</span><br><span class="line">    └── undo_002</span><br><span class="line"></span><br><span class="line">9 directories, 22 files</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>kubernetes</tag>
        <tag>k8s</tag>
        <tag>cloud native</tag>
        <tag>pv</tag>
        <tag>pvc</tag>
      </tags>
  </entry>
</search>
